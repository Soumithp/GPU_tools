Bootstrap: docker
From: nvidia/cuda:11.8.0-devel-ubuntu22.04

%labels
    Author Soumith
    Version 1.0
    Description RFdiffusion - de novo protein structure generation via diffusion

%post
    apt-get update && apt-get install -y \
        wget bzip2 ca-certificates curl git build-essential \
        && rm -rf /var/lib/apt/lists/*

    # Install Miniconda
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh
    bash /tmp/miniconda.sh -b -p /opt/conda
    rm /tmp/miniconda.sh
    export PATH="/opt/conda/bin:$PATH"

    # Clone RFdiffusion
    cd /opt
    git clone https://github.com/RosettaCommons/RFdiffusion.git
    cd RFdiffusion

    # Create conda environment from their spec
    conda env create -f env/SE3nv.yml
    . /opt/conda/etc/profile.d/conda.sh
    conda activate SE3nv

    # Install SE3Transformer
    cd env/SE3Transformer
    pip install --no-cache-dir -r requirements.txt
    python setup.py install
    cd ../..

    # Install RFdiffusion
    pip install -e .

    # Download model weights
    mkdir -p models
    cd models
    wget -q http://files.ipd.uw.edu/pub/RFdiffusion/6f5902ac237024bdd0c176cb93063dc4/Base_ckpt.pt
    wget -q http://files.ipd.uw.edu/pub/RFdiffusion/e29311f6f1bf1af907f9ef9f44b8328b/Complex_base_ckpt.pt
    wget -q http://files.ipd.uw.edu/pub/RFdiffusion/60f09a193fb5e5ccdc4980f613f7f168/ActiveSite_ckpt.pt
    cd ..

    conda clean -afy && pip cache purge

%environment
    export PATH="/opt/conda/bin:$PATH"
    . /opt/conda/etc/profile.d/conda.sh
    conda activate SE3nv
    export RFDIFFUSION_DIR="/opt/RFdiffusion"

%runscript
    echo "RFdiffusion - De Novo Protein Design Container"
    echo "Usage: singularity exec --nv rfdiffusion.sif python /opt/RFdiffusion/scripts/run_inference.py \\"
    echo "  inference.output_prefix=output/design \\"
    echo "  'contigmap.contigs=[150-150]'"
    exec "$@"

%test
    export PATH="/opt/conda/bin:$PATH"
    . /opt/conda/etc/profile.d/conda.sh
    conda activate SE3nv
    python -c "import torch; print(f'PyTorch: {torch.__version__}')"
    python -c "from rfdiffusion.inference.model_runners import InferenceModel; print('RFdiffusion ready')"
    echo "Container test passed"
