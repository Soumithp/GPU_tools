Bootstrap: docker
From: nvidia/cuda:12.1.0-cudnn8-runtime-ubuntu22.04

%post
    # Update and install dependencies
    apt-get update && apt-get install -y \
        python3.10 \
        python3-pip \
        wget \
        git \
        && rm -rf /var/lib/apt/lists/*
    
    # Upgrade pip
    python3 -m pip install --upgrade pip
    
    # Install PyTorch with CUDA 12.1 support
    pip3 install torch==2.1.0 torchvision==0.16.0 torchaudio==2.1.0 \
        --index-url https://download.pytorch.org/whl/cu121
    
    # Install scientific computing libraries
    pip3 install numpy==1.24.3 scipy==1.11.3 pandas==2.1.1
    
    # Install visualization
    pip3 install matplotlib==3.8.0 seaborn==0.13.0
    
    # Install machine learning utilities
    pip3 install scikit-learn==1.3.1
    
    # Install ESM2 and dependencies
    pip3 install fair-esm==2.0.0 biotite==0.37.0 biopython==1.81

%environment
    export PYTHONPATH=/usr/local/lib/python3.10/dist-packages:$PYTHONPATH
    export CUDA_VISIBLE_DEVICES=0

%test
    # Verify installations
    python3 -c "import torch; print(f'PyTorch: {torch.__version__}')"
    python3 -c "import torch; print(f'CUDA available: {torch.cuda.is_available()}')"
    python3 -c "import esm; print(f'ESM: {esm.__version__}')"

%labels
    Author soumith.p6@gmail.com
    Version 2.0.0
    Description ESM2 protein language model with GPU support
    PyTorch_Version 2.1.0
    CUDA_Version 12.1

%help
    ESM2 (Evolutionary Scale Modeling) for protein sequence analysis.
    
    Usage:
        singularity exec --nv esm2.sif python3 generate_embeddings.py proteins.fasta
    
    Note: The --nv flag is REQUIRED for GPU access.
    
    Building:
    - sudo singularity build esm2.sif esm2.def
    - Or: singularity build --fakeroot esm2.sif esm2.def